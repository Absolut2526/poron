<!DOCTYPE html>
<html>
<body>
<button onclick="start()">Start voice</button>
<audio autoplay></audio>

<script>
let pc, ws;

async function start() {
  ws = new WebSocket("ws://localhost:8000/ws");

  pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  stream.getTracks().forEach(t => pc.addTrack(t, stream));

  pc.ontrack = e => {
    document.querySelector("audio").srcObject = e.streams[0];
  };

  pc.onicecandidate = e => {
    if (e.candidate) ws.send(JSON.stringify(e.candidate));
  };

  ws.onmessage = async e => {
    const data = JSON.parse(e.data);
    if (data.sdp) {
      await pc.setRemoteDescription(data);
      if (data.type === "offer") {
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify(answer));
      }
    } else {
      await pc.addIceCandidate(data);
    }
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify(offer));
}
</script>
</body>
</html>
